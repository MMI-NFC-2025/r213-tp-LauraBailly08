---
import Header from "../../components/Header.astro";
import Layout from "../../layouts/Layout.astro";
import OffreCard from "../../components/OffreCard.astro";
import { getOffres, filterByPrix } from "../../js/backend.mjs";  
  let offres = await getOffres();
  let message = '';
if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const minPrix = parseInt(data.get("minPrix") as string);
    const maxPrix = parseInt(data.get("maxPrix") as string);

    if (minPrix > 0 && maxPrix > 0 && maxPrix > minPrix) {
        offres = await filterByPrix(minPrix, maxPrix);
        if (offres.length === 0) {
            message = `Pas d'offres entre ${minPrix}€ et ${maxPrix}€`;
        } else {
            message = `Liste des offres entre ${minPrix}€ et ${maxPrix}€`;
        }
    } else {
        message = "Veuillez entrer des valeurs valides pour le prix.";
    }
} else {
    offres = await getOffres();
}
---

<Layout titre="Offres">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    .font-cute {
      font-family: 'Nunito', sans-serif;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <div class="font-cute min-h-screen bg-rose-50 p-8">
    
    <div class="max-w-6xl mx-auto mb-10 text-center">
      <h1 class="text-5xl font-extrabold text-rose-500 mb-6 drop-shadow-sm">
         Nos Offres 
      </h1>
      
      <p class="text-rose-400 mb-8 text-lg font-medium">
         ˚₊‧꒰ა Les favoris ໒꒱ ‧₊˚
      </p>
      
      <div class="mb-8 text-center">
        <a
          href="/offres/surface/80"
          class="group relative inline-flex items-center justify-center px-8 py-3
                 bg-white text-rose-500 font-bold text-lg rounded-full
                 border-2 border-rose-200 shadow-[0_4px_0_rgb(253,164,175)]
                 active:shadow-none active:translate-y-1
                 transition-all duration-200 ease-in-out hover:bg-rose-50"
        >
          <span class="mr-2 group-hover:scale-110 transition-transform">&lt;3</span>
          Voir les maisons de plus de 80 m²
        </a>
      </div>
      <button 
        id="favori-button" 
        class="group relative inline-flex items-center justify-center px-8 py-3 
               bg-white text-rose-500 font-bold text-lg rounded-full 
               border-2 border-rose-200 shadow-[0_4px_0_rgb(253,164,175)] 
               active:shadow-none active:translate-y-1 
               transition-all duration-200 ease-in-out hover:bg-rose-50"
      >
        <span class="mr-2 group-hover:scale-110 transition-transform">&lt;3</span>
        <span id="btn-text">Afficher les favoris</span>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
      {
        offres.map(offre => (
          <div class="offre transition-all duration-300 hover:-translate-y-2" data-favori={offre.Favoris.toString()}>
            <div class="h-full bg-white rounded-3xl p-4 shadow-lg shadow-rose-100/50 border border-rose-100">
               <OffreCard offre={offre} />
            </div>
          </div>
        ))
      }
    </div>


  <script>
    const button = document.getElementById('favori-button');
    const btnText = document.getElementById('btn-text');
    let showOnlyFavorites = false;

    button?.addEventListener('click', () => {
      showOnlyFavorites = !showOnlyFavorites;
      const offres = document.querySelectorAll('.offre');
      let visibleCount = 0;

      offres.forEach(offre => {
        const el = offre as HTMLElement; 
        const isFavori = el.dataset.favori === 'true';

        if (showOnlyFavorites && !isFavori) {
          el.style.display = 'none';
        } else {
          el.style.display = '';
          el.classList.add('fade-in'); 
          visibleCount++;
          
         
          setTimeout(() => el.classList.remove('fade-in'), 500);
        }
      });

      if (btnText) {
        btnText.textContent = showOnlyFavorites 
          ? 'Afficher tout' 
          : 'Afficher les favoris';
      }
    });
    
  </script>

  <form action="/offres" method="POST">
    <input type="number" name="minPrix" placeholder="Prix minimum" />
    <input type="number" name="maxPrix" placeholder="Prix maximum" />
    <input type="submit" value="Filtrer par prix" />
</form>

</Layout>